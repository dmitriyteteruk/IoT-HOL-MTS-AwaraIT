### 2.2. Установка Azure IoT Edge Runtime на шлюз.
На предыдущих этапах мы развернули Azure IoT Hub, добавили в него устройство класса IoT Edge и запустили виртуальную машину, которая будет выступать у нас в роли шлюза. Теперь нам необходимо установить Azure IoT Edge Runtime на наш шлюз. Azure IoT Edge Runtime будет отвечать за коммуникацию с Azure IoT Hub и управлять контейнерными нагрузками.

1. На странице обзора виртуальной машины скопируйте **Общедоступный IP-адрес**.

![image](https://user-images.githubusercontent.com/34028526/155173905-992e7d8c-b5a5-4377-987e-8b2ef5245119.png)

---

2. Откройте на локальном компютере командную строку или PowerShell для Windows 10/11 или Putty (или другой клиент или терминал на Linux).
Запустите команду `SSH azurestackuser@ПУБЛИЧНЫЙ-IP-АДРЕС-ВМ` и при запросе пароля введите `HOLpassword123!` и нажмите ввод.
В случае удачного ввода вы должны увидеть сообщение как на скриншоте, наберите **yes** и нажмите ввод.

![image](https://user-images.githubusercontent.com/34028526/155206712-82b4eb94-1c20-4fb6-a4a3-2574fcbc95c8.png)

После успешной авторизации вы увидите привественное окно аналогичное скриншоту ниже. При этом командная строка будет начинаться с `azurestackuser@iot-edge-gw:~$`

![image](https://user-images.githubusercontent.com/34028526/155207013-10f5e7e0-290d-4444-81f9-ef2050c54236.png)


---

3. Скопируйте нижеследующие код в окно Powershell и нажмите ввод.
``` Bash
wget https://packages.microsoft.com/config/ubuntu/18.04/multiarch/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
sudo dpkg -i packages-microsoft-prod.deb
rm packages-microsoft-prod.deb
```

4. Установите контейнерный движок Moby. Для это введите нижеследующий код в окно PowerShell и нажмите ввод.
``` Bash
sudo apt-get update; \
  sudo apt-get install moby-engine -y
```

5. Установите новейшую версию Azure IoT Edge Runtime. Для этого скопируйте нижеследующий код в окно PowerShell и нажмите ввод.
``` Bash
sudo apt-get update; \
  sudo apt-get install aziot-edge -y
```
6. Теперь необходимо добавить в Azure IoT Edge информацию о подключении к IoT Hub. Скопируйте код из окна ниже и замените `PASTE_DEVICE_CONNECTION_STRING_HERE` строкой подключения, которую вы скопировали при создании IoT Edge устройства ранее `HostName=iot-hol-mts-awara.azure-devices.net;DeviceId=iot-edge-gw;SharedAccessKey=XXXX..........XXXXX` 
``` Bash
sudo iotedge config mp --connection-string 'PASTE_DEVICE_CONNECTION_STRING_HERE'
```
В случае успешного подтверждения вы увидите скриншот как ниже

![image](https://user-images.githubusercontent.com/34028526/155209816-cd2953b4-6a22-4ede-97e4-41b6d3d2d246.png)

Для применения конфигурации скопируйте нижеследующую команду в окно PowerShell и нажмите ввод
```Bash
sudo iotedge config apply
```

В случае успешного применения файла конфигруации вы увидите окно как на скриншоте ниже:

![image](https://user-images.githubusercontent.com/34028526/155210220-be03423f-f564-415c-940c-280e283f82ad.png)

---

7. В рамках данной практической работы мы используем частный реестр контейнеров, который находится в дата-центре МТС и поэтому мы используем НЕБЕЗОПАСНОЕ соединение. 
Для работы движка контейнеров с небезопасным реестром необходимо внести изменения в файл конфигурации движка. Для этого введите следующую команду в окне PowerShell:
```Bash
sudo nano /etc/docker/daemon.json
```

В открывшемся окне текстового редактора добавьсте следующий текст
```Bash
{
  "insecure-registries" : ["docker-private-registry-at-mts.azuremsk.cloudapp.ec.mts.ru:5000"]
}
```

![image](https://user-images.githubusercontent.com/34028526/155213949-feae0959-efc7-4142-8dc7-78f2dbde7823.png)

Затем нажмите **Ctrl+O** и **ввод** для сохранения изменений в файле, затем нажмите **Ctrl+X** для выхода из окна текстового редактора.

Наберите следующую команду `sudo reboot` для перезагрузки виртуальной машины. После перезагрузки IoT Edge устройство сможет подклоючиться к реестру контейнеров в дата центре МТС и скачать необходимый образ.

---

8. Подключитесь снова к виртуальной машине по SSH и введите команду `iotedge list`, в результете вы должны увидеть ответ как на скриншоте ниже, с информацией о том, что на устройстве запущены и работают 3 модуля: 2 системных и 1 модуль MTS.

![image](https://user-images.githubusercontent.com/34028526/155213802-384c6f2d-b89f-4ef4-a7df-72182d2c0dc5.png)


